{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Specifies the location for all resources."
            }
        },
        "synapseWorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "Specifies the name of the synapse workspace."
            }
        },
        "storageContainerId": {
            "type": "string",
            "metadata": {
                "description": "Specifies the resource Id of the default storage account container for synapse."
            }
        },
        "sqlAdministratorLogin": {
            "type": "string",
            "metadata": {
                "description": "Specifies the login account name for the SQL DW of the synapse workspace."
            }
        },
        "sqlAdministratorPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Specifies the password for the SQL DW of the synapse workspace."
            }
        },
        "datalakeAnalyticsResourceId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Specifies the resource ID of data lake analytics for the synapse workspace."
            }
        },
        "computeSubnetResourceId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Specifies the resource ID of data lake analytics for the synapse workspace."
            }
        },
        "sqlAdminGroupName": {
            "type": "string",
            "metadata": {
                "description": "Specifies the name of the Azure Active Directory group of the SQL admin group."
            }
        },
        "sqlAdminGroupObjectID": {
            "type": "string",
            "metadata": {
                "description": "Specifies the Azure Active Directory objectID of the SQL admin group."
            }
        }
    },
    "variables": {
        "location": "[parameters('location')]",
        "synapseWorkspaceName": "[parameters('synapseWorkspaceName')]",
        "storageContainerId": "[parameters('storageContainerId')]",
        "storageAccountName": "[split(variables('storageContainerId'), '/')[8]]",
        "storageContainerName": "[last(split(variables('storageContainerId'), '/'))]",
        "sqlAdministratorLogin": "[parameters('sqlAdministratorLogin')]",
        "sqlAdministratorPassword": "[parameters('sqlAdministratorPassword')]",
        "datalakeAnalyticsResourceId": "[parameters('datalakeAnalyticsResourceId')]",
        "computeSubnetResourceId": "[parameters('computeSubnetResourceId')]",
        "sqlAdminGroupName": "[parameters('sqlAdminGroupName')]",
        "sqlAdminGroupObjectID": "[parameters('sqlAdminGroupObjectID')]"
    },
    "resources": [
        {
            "type": "Microsoft.Synapse/workspaces",
            "apiVersion": "2019-06-01-preview",
            "name": "[variables('synapseWorkspaceName')]",
            "location": "[variables('location')]",
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "defaultDataLakeStorage": {
                    "accountUrl": "[concat('https://', variables('storageAccountName'), '.dfs.core.windows.net')]",
                    "filesystem": "[variables('storageContainerName')]"
                },
                "sqlAdministratorLogin": "[variables('sqlAdministratorLogin')]",
                "sqlAdministratorLoginPassword": "[variables('sqlAdministratorPassword')]",
                "adlaResourceId": "[variables('datalakeAnalyticsResourceId')]",
                "managedVirtualNetwork": "default",
                "virtualNetworkProfile": {
                    "computeSubnetId": "[variables('computeSubnetResourceId')]"
                },
                "connectivityEndpoints": {}
            },
            "resources": [
                {
                    "type": "firewallRules",
                    "apiVersion": "2019-06-01-preview",
                    "name": "firewallRules",
                    "dependsOn": [
                        "[concat('Microsoft.Synapse/workspaces/', variables('synapseWorkspaceName'))]"
                    ],
                    "properties": {
                        "startIpAddress": "0.0.0.0",
                        "endIpAddress": "255.255.255.255"
                    }
                },
                {
                    "type": "managedIdentitySqlControlSettings",
                    "apiVersion": "2019-06-01-preview",
                    "name": "default",
                    "dependsOn": [
                        "[concat('Microsoft.Synapse/workspaces/', variables('synapseWorkspaceName'))]"
                    ],
                    "properties": {
                        "grantSqlControlToManagedIdentity": {
                            "desiredState": "Enabled"
                        }
                    }
                },
                {
                    "condition": "[and(not(empty(variables('sqlAdminGroupName'))), not(empty(variables('sqlAdminGroupObjectID'))))]",
                    "type": "administrators",
                    "apiVersion": "2019-06-01-preview",
                    "name": "ActiveDirectory",
                    "dependsOn": [
                        "[concat('Microsoft.Synapse/workspaces/', variables('synapseWorkspaceName'))]"
                    ],
                    "properties": {
                        "administratorType": "ActiveDirectory",
                        "login": "[variables('sqlAdminGroupName')]",
                        "sid": "[variables('sqlAdminGroupObjectID')]",
                        "tenantId": "[subscription().tenantId]"
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Synapse/workspaces/bigDataPools",
            "apiVersion": "2019-06-01-preview",
            "name": "[concat(variables('synapseWorkspaceName'), '/defaultSqlPool')]",
            "dependsOn": [
                "[concat('Microsoft.Synapse/workspaces/', variables('synapseWorkspaceName'))]"
            ],
            "location": "[variables('location')]",
            "properties": {
                "autoPause": {
                    "enabled": true,
                    "delayInMinutes": 15
                },
                "autoScale": {
                    "enabled": true,
                    "minNodeCount": 1,
                    "maxNodeCount": 4
                },
                "defaultSparkLogFolder": "logs/",
                "libraryRequirements": {
                    "content": "",
                    "filename": "requirements.txt"
                },
                "nodeCount": 4,
                "nodeSize": "Medium",
                "nodeSizeFamily": "MemoryOptimized",
                "provisioningState": "Succeeded",
                "sparkEventsFolder": "events/",
                "sparkVersion": "2.4"
            }
        },
        {
            "type": "Microsoft.Synapse/workspaces/sqlPools",
            "apiVersion": "2019-06-01-preview",
            "name": "[concat(variables('synapseWorkspaceName'), '/defaultSqlPool')]",
            "dependsOn": [
                "[concat('Microsoft.Synapse/workspaces/', variables('synapseWorkspaceName'))]"
            ],
            "location": "[variables('location')]",
            "sku": {
                "name": "DW100c"
            },
            "properties": {
                "collation": "SQL_Latin1_General_CP1_CI_AS",
                "createMode": "Default",
                "maxSizeBytes": 263882790666240,
                "provisioningState": "Succeeded",
                // "recoverableDatabaseId": "",
                // "restorePointInTime": "",
                // "sourceDatabaseId": "",
                // "creationDate": "",
                "status": "Online"
            }
        }
        // {
        //     "type": "Microsoft.Synapse/workspaces/integrationRuntimes",
        //     "apiVersion": "2019-06-01-preview",
        //     "name": "[concat(variables('synapseWorkspaceName'), '/defaultIntegrationRuntime')]",
        //     "location": "[variables('location')]",
        //     "properties": {
        //         "type": "Managed",
        //         "typeProperties": {
        //             "computeProperties": {
        //                 "additionalProperties": {
        //                 },
        //                 "dataFlowProperties": {
        //                     "additionalProperties": {
        //                     },
        //                     "computeType": "General",
        //                     "coreCount": 2,
        //                     "timeToLive": 15
        //                 },
        //                 "maxParallelExecutionsPerNode": 1,
        //                 "nodeSize": "",
        //                 "numberOfNodes": 2,
        //                 "vNetProperties": {
        //                     "additionalProperties": {
        //                     },
        //                     "publicIPs": [
        //                     ],
        //                     "subnet": "",
        //                     "vNetId": ""
        //                 }
        //             },
        //             "linkedInfo": {
        //                 "authorizationType": "RBAC"
        //             },
        //             "ssisProperties": {
        //                 "additionalProperties": {
        //                 },
        //                 "catalogInfo": {
        //                     "additionalProperties": {
        //                     },
        //                     "catalogAdminPassword": {
        //                         "type": "SecureString",
        //                         "value": ""
        //                     },
        //                     "catalogAdminUserName": "",
        //                     "catalogPricingTier": "Standard",
        //                     "catalogServerEndpoint": ""
        //                 },
        //                 "customSetupScriptProperties": {
        //                     "blobContainerUri": "",
        //                     "sasToken": {
        //                         "type": "SecureString",
        //                         "value": ""
        //                     }
        //                 },
        //                 "dataProxyProperties": {
        //                     "connectVia": {
        //                         "referenceName": "",
        //                         "type": "IntegrationRuntimeReference"
        //                     },
        //                     "path": "",
        //                     "stagingLinkedService": {
        //                         "referenceName": "",
        //                         "type": "IntegrationRuntimeReference"
        //                     }
        //                 },
        //                 "edition": "Enterprise",
        //                 "expressCustomSetupProperties": [
        //                     {
        //                         "type": "EnvironmentVariableSetup",
        //                         "typeProperties": {
        //                             "componentName": "",
        //                             "licenseKey": {
        //                                 "type": "SecureString",
        //                                 "value": ""
        //                             },
        //                             "password": {
        //                                 "type": "SecureString",
        //                                 "value": ""
        //                             },
        //                             "targetName": {
        //                             },
        //                             "userName": {
        //                             },
        //                             "variableName": "",
        //                             "variableValue": ""
        //                         }
        //                     }
        //                 ],
        //                 "licenseType": "LicenseIncluded"
        //             }
        //         },
        //         "additionalProperties": {
        //         },
        //         "description": ""
        //     }
        // }
    ]
}